version: '3.5'
x-project-volume:
  &local-files
  type: bind
  source: .
  target: /app

x-shared-volume:
  &shared-files
  type: volume
  source: dist
  target: /app/dist

volumes:
  dist:
  node_modules:

services:  
  transpiler:
    build: .
    environment:
      NODE_ENV: development
    volumes:
      - *local-files
      - *shared-files
      - node_modules:/app/node_modules
    command: yarn build
  cli:
    build: ./src
    depends_on:
      - "transpiler"
    volumes:
      - *local-files
      - *shared-files
      - node_modules:/app/node_modules
  test:
    build: ./tests
    depends_on:
      - "transpiler"
    volumes:
      - *local-files
      - *shared-files
      - node_modules:/app/node_modules  
    command: yarn test